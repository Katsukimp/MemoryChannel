using Microsoft.Extensions.Logging.Abstractions;
using Microsoft.Extensions.Logging.Console;
using Microsoft.Extensions.Options;
namespace MemoryEventBus.Presentation.Formatter.Logging
{
    public class CustomConsoleFormatter : ConsoleFormatter
    {
        private readonly IOptionsMonitor<CustomConsoleFormatterOptions> _options;

        public CustomConsoleFormatter(IOptionsMonitor<CustomConsoleFormatterOptions> options)
            : base("custom")
        {
            _options = options;
        }

        public override void Write<TState>(in LogEntry<TState> logEntry, IExternalScopeProvider? scopeProvider, TextWriter textWriter)
        {
            var options = _options.CurrentValue;
            var timestamp = DateTime.Now.ToString(options.TimestampFormat);
            var level = GetLogLevelString(logEntry.LogLevel);
            var category = GetShortCategoryName(logEntry.Category);

            var levelColor = GetLogLevelColor(logEntry.LogLevel);
            
            textWriter.Write($"{timestamp}");
            textWriter.Write($"[{levelColor}{level}\u001b[0m] ");
            textWriter.Write($"{category}: ");
            textWriter.WriteLine(logEntry.Formatter(logEntry.State, logEntry.Exception));

            if (logEntry.Exception != null)
                textWriter.WriteLine($"    Exception: {logEntry.Exception}");
        }

        private static string GetLogLevelString(LogLevel logLevel) => logLevel switch
        {
            LogLevel.Trace => "TRCE",
            LogLevel.Debug => "DBUG",
            LogLevel.Information => "INFO",
            LogLevel.Warning => "WARN",
            LogLevel.Error => "ERRO",
            LogLevel.Critical => "CRIT",
            _ => "UNKN"
        };

        private static string GetLogLevelColor(LogLevel logLevel) => logLevel switch
        {
            LogLevel.Trace => "\u001b[37m",      
            LogLevel.Debug => "\u001b[36m",      
            LogLevel.Information => "\u001b[32m", 
            LogLevel.Warning => "\u001b[33m",     
            LogLevel.Error => "\u001b[31m",       
            LogLevel.Critical => "\u001b[35m",    
            _ => "\u001b[0m"                      
        };

        private static string GetShortCategoryName(string category)
        {
            var parts = category.Split('.');
            if (parts.Length > 2)
                return $"{parts[0]}...{parts[^1]}";
            return category;
        }
    }

    public class CustomConsoleFormatterOptions
    {
        public string TimestampFormat { get; set; } = "[yyyy-MM-dd HH:mm:ss.fff] ";
    }
}